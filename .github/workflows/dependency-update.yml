name: ðŸ“¦ Dependency Updates

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-dependencies:
    name: ðŸ”„ Update Python Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v6

      - name: ðŸ”„ Update dependencies
        run: |
          uv pip compile pyproject.toml -o requirements.txt --upgrade
          uv lock --upgrade

      - name: ðŸ§ª Test updated dependencies
        run: |
          uv pip install --system -e ".[dev]"
          pytest tests/ --tb=short -q

      - name: ðŸ” Check for outdated packages
        run: |
          pip list --outdated --format=json > outdated.json
          echo "## ðŸ“¦ Outdated Packages" >> outdated.md
          python -c "
          import json
          with open('outdated.json') as f:
              packages = json.load(f)
          if packages:
              print('| Package | Current | Latest | Type |')
              print('|---------|---------|--------|------|')
              for p in packages:
                  print(f\"| {p['name']} | {p['version']} | {p['latest_version']} | {p.get('latest_filetype', 'wheel')} |\")
          else:
              print('All packages are up to date! ðŸŽ‰')
          " >> outdated.md

      - name: ðŸ“ Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'ðŸ”„ Weekly Dependency Updates'
          body: |
            ## ðŸ“¦ Automated Dependency Update

            This PR contains the weekly dependency updates.

            ### Changes
            - Updated Python dependencies to latest versions
            - Regenerated lock file

            ### Testing
            - âœ… All tests pass with updated dependencies

            ### Review Checklist
            - [ ] Review version changes for breaking updates
            - [ ] Check security advisories for updated packages
            - [ ] Verify no unexpected dependency additions

            ---
            *This PR was automatically created by the dependency update workflow*
          branch: deps/weekly-update
          delete-branch: true
          labels: |
            dependencies
            automated
          assignees: beelzer
          reviewers: beelzer

  renovate-auto-merge:
    name: ðŸ¤– Auto-merge Renovate PRs
    runs-on: ubuntu-latest
    if: github.actor == 'renovate[bot]' || github.actor == 'renovate-bot'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ðŸ” Check PR labels
        id: check-labels
        run: |
          PR_LABELS=$(gh pr view "${{ github.event.pull_request.number }}" --json labels --jq '.labels[].name' | tr '\n' ' ')
          echo "labels=$PR_LABELS" >> "$GITHUB_OUTPUT"

          # Check if this is a patch or minor update based on labels
          if echo "$PR_LABELS" | grep -E "(patch|minor)" > /dev/null; then
            echo "should_merge=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_merge=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Auto-approve PR
        if: steps.check-labels.outputs.should_merge == 'true'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”€ Auto-merge PR
        if: steps.check-labels.outputs.should_merge == 'true'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
